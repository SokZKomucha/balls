(()=>{"use strict";const e=40,t=["black","blue","orange","pink","red","white","yellow"];class i{constructor(e,t){Object.defineProperty(this,"position",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"color",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.position=e,this.color=t}clone(){return new i(this.position.clone(),this.color)}moveTo(e){this.position.x=e.x,this.position.y=e.y}}class o{constructor(){Object.defineProperty(this,"eventListeners",{enumerable:!0,configurable:!0,writable:!0,value:{}})}on(e,t){var i;const o=null!==(i=this.eventListeners[e])&&void 0!==i?i:new Set;o.add(t),this.eventListeners[e]=o}emit(e,t){var i;(null!==(i=this.eventListeners[e])&&void 0!==i?i:new Set).forEach((e=>e(t)))}}class n{constructor(e,t){Object.defineProperty(this,"x",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"y",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.x=e,this.y=t}clone(){return new n(this.x,this.y)}compareTo(e){return this.x===e.x&&this.y===e.y}toString(){return`(${this.x}, ${this.y})`}}class l{constructor(){Object.defineProperty(this,"elements",{enumerable:!0,configurable:!0,writable:!0,value:[]})}enqueue(e){this.elements.push(e)}dequeue(){return this.elements.shift()}get Size(){return this.elements.length}}var s,r;const a=document.getElementById("grid"),h=document.querySelectorAll(".next-ball"),c=document.querySelector("#highscore"),d=document.querySelector("#score"),u=new class{constructor(){Object.defineProperty(this,"canvas",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"context",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"eventEmitter",{enumerable:!0,configurable:!0,writable:!0,value:new o}),Object.defineProperty(this,"running",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"balls",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"createBallsAfterMove",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"highlightedPath",{enumerable:!0,configurable:!0,writable:!0,value:null}),Object.defineProperty(this,"highlightedPathColor",{enumerable:!0,configurable:!0,writable:!0,value:"rgb(242, 175, 170)"}),Object.defineProperty(this,"nextColors",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"selectedBallIndex",{enumerable:!0,configurable:!0,writable:!0,value:null}),this.canvas=document.createElement("canvas"),this.context=this.canvas.getContext("2d"),this.canvas.width=360,this.canvas.height=360,this.canvas.addEventListener("click",(e=>this.clickEvent(e))),this.canvas.addEventListener("mousemove",(e=>this.hoverEvent(e)))}clickEvent(t){if(!this.running)return;const i=Math.floor(t.offsetX/e),o=Math.floor(t.offsetY/e),l=new n(i,o);if(this.highlightedPath&&"rgb(200, 200, 200)"===this.highlightedPathColor)return this.highlightedPath=null,this.createBallsAfterMove&&this.createNewBalls(),void this.render();if(this.highlightedPath=null,null!==this.selectedBallIndex)if(this.balls[this.selectedBallIndex].position.compareTo(l))this.selectedBallIndex=null;else if(this.balls.find((e=>e.position.compareTo(l)))&&this.canBeSelected(l))this.selectedBallIndex=this.balls.findIndex((e=>e.position.compareTo(l)));else{const e=this.balls[this.selectedBallIndex].position.clone(),t=l,i=this.pathfind(e,t);if(0===i.length)return;this.balls[this.selectedBallIndex].moveTo(l),this.highlightedPathColor="rgb(200, 200, 200)",this.highlightedPath=i,this.selectedBallIndex=null;const o=this.checkBallCrossings();0!==o?(this.createBallsAfterMove=!1,this.emit("onBallRemove",o)):this.createBallsAfterMove=!0}else{const e=this.balls.findIndex((e=>e.position.compareTo(l)));if(-1===e)return;if(!this.canBeSelected(l))return;this.selectedBallIndex=e}this.render()}hoverEvent(t){if(!this.running)return;const i=Math.floor(t.offsetX/e),o=Math.floor(t.offsetY/e),l=new n(i,o);if(null==this.selectedBallIndex)return;const s=this.balls[this.selectedBallIndex].position.clone(),r=this.pathfind(s,l);this.highlightedPathColor="rgb(242, 175, 170)",this.highlightedPath=r,this.render()}canBeSelected(e){const t=this.balls.filter((t=>t.position.compareTo(new n(e.x-1,e.y))||t.position.compareTo(new n(e.x+1,e.y))||t.position.compareTo(new n(e.x,e.y-1))||t.position.compareTo(new n(e.x,e.y+1))));return!(4===t.length||3===t.length&&[0,8].includes(e.x)||3===t.length&&[0,8].includes(e.y)||2===t.length&&[0,8].includes(e.x)&&[0,8].includes(e.y))}checkBallCrossings(){const e=[{dx:1,dy:0},{dx:0,dy:1},{dx:1,dy:1},{dx:1,dy:-1}],t=new Set;for(const i of this.balls)for(const o of e){const e=[i];let n=i.position.x+o.dx,l=i.position.y+o.dy;for(;n>=0&&n<9&&l>=0&&l<9;){const t=this.balls.find((e=>e.position.x===n&&e.position.y===l&&e.color===i.color));if(!t)break;e.push(t),n+=o.dx,l+=o.dy}e.length>=5&&e.forEach((e=>t.add(e.position.toString())))}return this.balls=this.balls.filter((e=>!t.has(e.position.toString()))),t.size}createInitialBalls(){for(let e=0;e<8;e++){const o=Math.floor(9*Math.random()),l=Math.floor(9*Math.random()),s=new n(o,l);if(this.balls.some((e=>e.position.compareTo(s)))){e--;continue}const r=t[Math.floor(Math.random()*t.length)];this.balls.push(new i(s,r))}for(let e=0;e<3;e++)this.nextColors[e]=t[Math.floor(Math.random()*t.length)];this.emit("onNewNextColors",this.nextColors)}createNewBalls(){if(this.balls.length+3>=81)return this.running=!1,void this.emit("onGameOver",void 0);for(let e=0;e<3;e++){const o=Math.floor(9*Math.random()),l=Math.floor(9*Math.random()),s=new n(o,l);this.balls.some((e=>e.position.compareTo(s)))?e--:(this.balls.push(new i(s,this.nextColors[e])),this.nextColors[e]=t[Math.floor(Math.random()*t.length)])}this.emit("onNewNextColors",this.nextColors)}pathfind(e,t){const i=new l,o=new Set,s=new Map;for(i.enqueue(e),o.add(e.toString()),s.set(e.toString(),null);i.Size>0;){const e=i.dequeue();if(e.compareTo(t)){const t=[];let i=e;for(;i;)t.unshift(i),i=s.get(i.toString())||null;return t}for(const t of[[1,0],[-1,0],[0,1],[0,-1]]){const l=new n(e.x+t[0],e.y+t[1]),r=l.toString();!o.has(r)&&l.x>=0&&l.x<9&&l.y>=0&&l.y<9&&!this.balls.some((e=>e.position.compareTo(l)))&&(i.enqueue(l),o.add(r),s.set(r,e))}}return[]}render(){this.context.clearRect(0,0,this.canvas.width,this.canvas.height),this.highlightedPath&&this.highlightedPath.forEach((t=>{this.context.fillStyle=this.highlightedPathColor,this.context.fillRect(t.x*e,t.y*e,e,e)})),this.balls.forEach((t=>{this.context.fillStyle=t.color,this.context.beginPath(),this.context.arc(t.position.x*e+20,t.position.y*e+20,null!==this.selectedBallIndex&&this.balls[this.selectedBallIndex].position.compareTo(t.position)?12.5:10,0,2*Math.PI),this.context.fill(),this.context.stroke(),this.context.closePath()}))}on(e,t){this.eventEmitter.on(e,t)}emit(e,t){this.eventEmitter.emit(e,t)}};let f=null!==(r=Number(null!==(s=localStorage.getItem("highscore"))&&void 0!==s?s:"0"))&&void 0!==r?r:0,b=0;a.appendChild(u.canvas),c.textContent=f.toString(),u.on("onNewNextColors",(e=>{e.forEach(((e,t)=>{h[t].style.backgroundColor=e}))})),u.on("onGameOver",(()=>{console.log("Game over!"),document.querySelector("#game-over").style.display="flex"})),u.on("onBallRemove",(e=>{b+=e,d.textContent=b.toString(),b>=f&&(f=b,localStorage.setItem("highscore",f.toString()),c.textContent=f.toString())})),u.createInitialBalls(),u.render(),u.canvas.style.outline="1px solid black",u.canvas.style.cursor="pointer"})();